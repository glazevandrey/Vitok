@using web_server.Models;
@model DisplayModelShedule
@{
    Layout = "_Layout";
}
<style>
    table {
  border-collapse: collapse;
}
table td, table th {
  border: 1px solid black;
}
table tr:first-child th {
  border-top: 0;
}
table tr:last-child td {
  border-bottom: 0;
}
table tr td:first-child,
table tr th:first-child {
  border-left: 0;
}
table tr td:last-child,
table tr th:last-child {
  border-right: 0;
}
</style>

<link rel="stylesheet" type="text/css" href="~/css/modal.css">

<label>Сегодня: @DateTime.Parse(DateTime.Now.Date.ToString()).ToString("dd.MM.yyyy")</label>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<div oncontextmenu="return false;">
    <div id="openmodal" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Выберите действие</h3>
                    <a href="#closeModal" title="Close" class="close">×</a>
                </div>
                <div class="modal-body">

                <label>Добавить свободный xас</label>
                <a href="#addhour">Ууу</a>
            </div>
                   <br/>
                   <br/>

                <label>Добавить занитяе</label>
                <a href="#choosestudent">Ууу</a>
            </div>
        </div>
 </div>

<div id="removeModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                   Удалить выбранное занятие?
                </h3>
                <a href="#closeModal" title="Close" class="close">×</a>
            </div>
            <div class="modal-body">
                <form method="post" action="/schedule/RemoveSchedule">
                    <input hidden="hidden" type="text" value="ss" id="removeDate" name="removeDate" />
                    <input hidden="hidden" type="text" value="ss" id="removeTutorId" name="removeTutorId" />
                    <input hidden="hidden" type="text" value="ss" id="removeUserId" name="removeUserId" />

                    <input type="submit" value="ОК" />
                    <input type="button" value="Отмена" href="#closeModal" />

                </form>
            </div>
        </div>
    </div>
</div>

<div id="addhour" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h3 class="modal-title">
                    Добавить свободный час на выбранную дату?
                </h3>
                    <a href="#closeModal" title="Close" class="close">×</a>
                </div>
                <div class="modal-body">
          
                <form method="post" action="/schedule/AddFreeTime">
                    <label for="looped">Повторяющееся занятие?</label>
                    <br/>
                    <input type="checkbox"  id="looped" name="looped" />
                    <br />
                    <br />
                    <input id="date2" name="date2" type="text" value="s" hidden="hidden" />
                    <input id="tutorId" name="tutorId" type="text" value="@ViewData["userid"]" hidden="hidden" />
                    <input type="submit" value="ОК" />
                    <input type="button" value="Отмена" href="#closeModal"/>

                </form>
            </div>
        </div>
    </div>
</div>
    
<div id="choosestudent" class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Выберите ученика и курс</h3>
                    <a href="#closeModal" title="Close" class="close">×</a>
                </div>
                <div class="modal-body">
                <form method="post" action="/schedule/AddSchedule">
                    <label for="looped">Повторяющееся занятие?</label>
                    <br />
                    <input type="checkbox" id="looped" name="looped" />
                    <br/>
                 <select name="userId" id="userId">

                        @{
                            Dictionary<int, string> d = new Dictionary<int, string>();
                            foreach (var item in Model.Schedules)
                            {
                                if (d.ContainsKey(item.UserId)){
                                    continue;
                                }

                                d.Add(item.UserId, item.UserName);
                                <option value="@item.UserId" >@item.UserName</option>
                        }
                    }
                </select>
                        <br />

                <select name="courses" id="courses">

                    @{
                        foreach (web_server.Models.Course item in (List<web_server.Models.Course>)ViewData["courses"])
                        {
                            <option value="@item.Id">Название: @item.Title Цель: @item.Goal.Title</option>
                        }
                    }

                </select>
                <br/>
                    <input id="date3" name="date3" type="text" value="s" hidden="hidden" />
                    <input id="tutorId" name="tutorId" type="text" value="@ViewData["userid"]" hidden="hidden" />
                <input type="submit" value="ОК" />
                <input type="button" value="Отмена" href="#closeModal" />
                </form>
                <script>
                    var el = document.getElementById("choosedDate");
                </script>

            </div>
        </div>
    </div>
</div>
<input id="choosedDate" type="text" value="s" hidden="hidden" />

<script>
    function clicked(time, s_day) {
        var date = document.getElementById("main-date").value;

        if(date.includes("янв")){
            date = date.replace("янв", "jan")
        }
        if(date.includes("фев")){
            date = date.replace("фев", "feb")
        }
        if(date.includes("мар")){
            date = date.replace("мар", "mar")

        }
        if(date.includes("апр")){
            date = date.replace("апр", "apr")

        }
        if (date.includes("май")) {
            date = date.replace("май", "may")

        }
        if(date.includes("июн")){
            date = date.replace("июн", "jun")

        }
        if(date.includes("июл")){
            date = date.replace("июл", "jul")

        }
        if(date.includes("авг")){
            date = date.replace("авг", "aug")

        }
        if (date.includes("сен")) {
            date = date.replace("сен", "sep")

        }
        if (date.includes("окт")) {
            date = date.replace("окт", "oct")

        }
        if (date.includes("ноя")) {
            date = date.replace("ноя", "nov")

        }
        if (date.includes("дек")) {
            date = date.replace("дек", "dec")
        }
 
        var dateString = s_day + " " + date + " " + time;
        const time2 = Date.parse(dateString);
        document.getElementById("choosedDate").value = dateString;
        document.getElementById("date2").value = dateString;
        document.getElementById("date3").value = dateString;

        window.location.href = "#openmodal";

    }
</script>
<div class="calendar">
    <div class="header">
        <form method="get" action="/schedule/downDate">
            <input hidden="hidden" id="date" name="date" value="@Model.Date" />
            <input type="submit" value="<<" />
        </form>
        <input id="main-date" class="main-date" disabled="disabled" type="text" value="@Model.Date.ToString("MMM yyyy")" />
        <form method="get" action="/schedule/upDate">
            <input hidden="hidden" id="date" name="date" value="@Model.Date"/>
            <input type="submit"  value=">>" />
        </form>
    </div>
    <br/>
    <table cellpadding="0" cellspacing="0">
    <tr>
        
            <th></th>

            <th> Пн @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).Day </th>
            <th> Вт @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(1).Day </th>
            <th> Ср @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(2).Day </th>
            <th> Чт @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(3).Day </th>
            <th> Пт @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(4).Day </th>
            <th> Сб @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(5).Day </th>
            <th> Вс @Model.Date.AddDays(-1 * (7 + (Model.Date.DayOfWeek - DayOfWeek.Monday)) % 7).AddDays(6).Day </th>
          
    </tr>
        @{
            var w_days = new List<DayOfWeek>()
            {
            DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, DayOfWeek.Saturday, DayOfWeek.Sunday
            };

            var hours = new List<string>()
            {
                "00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00","08:00", "09:00","10:00", "11:00","12:00", "13:00","14:00", "15:00","16:00", "17:00",
                "18:00", "19:00","20:00", "21:00","22:00", "23:00"
            };

            var countA = 0;

            foreach (var item in hours)
            {
                var countB = 1;

                <tr>
                
                <td>@item</td>
                    @{
                        foreach (var day in w_days)
                        {
                            var btn = $"{countA}_{countB}";
                            int s_day = -1;

                            <td>
                                @{
                                    if (@countB == 1)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).Day;
                                    }
                                    if (@countB == 2)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(1).Day;
                                    }
                                    if (@countB == 3)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(2).Day;
                                    }
                                    if (@countB == 4)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(3).Day;
                                    }
                                    if (@countB == 5)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(4).Day;
                                    }
                                    if (@countB == 6)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(5).Day;
                                    }
                                    if (@countB == 7)
                                    {
                                        s_day= Model.Date.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday).AddDays(6).Day;
                                    }
                            }
                         
                             <button class="@btn" id="@btn"  style="background-color:transparent;color:transparent; background-repeat:no-repeat;border:none;cursor:pointer;overflow:hidden;outline:none;width:auto" onclick="clicked('@item','@s_day')">clicked3</button>

                                <div>
                                    @{
                                        foreach (var model1 in Model.Schedules)
                                        {
                                            foreach (var m_date in model1.Date.dateTimes)
                                            {
                                                if(m_date.DayOfWeek == day)
                                                {
                                                    if(model1.Looped != true)
                                                    {
                                                        if (m_date != DateTime.Parse(s_day + " " + Model.Date.ToString("MMM yyyy") + " " + item))
                                                        {
                                                            continue;
                                                        }    
                                                    }
                                                    
                                                    if(m_date.Hour == DateTime.Parse(item).Hour)
                                                    {
                                                        if(ViewData["role"].ToString() == "Tutor")
                                                        {
                                                            if (string.IsNullOrEmpty(model1.UserName))
                                                            {                              
                                                                 <script>
                                                                    var elem = document.getElementsByClassName('@btn');
                                                                    elem[0].parentNode.removeChild(elem[0]);
                                                                    
                                                                    </script>
                                                               btn = $"btn_{model1.UserId}_{model1.Date.dateTimes[0].ToString("dd-MM-yyyy-HH-mm")}_{countA}_{countB}";
                                                                <button class="@btn" id="@btn" style="background-color:transparent;color:transparent; background-repeat:no-repeat;border:none;cursor:pointer;overflow:hidden;outline:none;width:auto" onclick="clicked('@item','@s_day')">clicked3</button>

                                                                <script>
                                                                   

                                                                    document.getElementsByClassName('@btn')[0].style.backgroundColor = "turquoise";

                                                                    $("#@btn").mousedown(function (e) {
                                                                        if (e.which === 3) {
                                                                            var _class = e.target.getAttribute("id");
                                                                            var sub = _class.split("_");
                                                                            var datee = sub[2];
                                                                            var userid = sub[1];

                                                                            var name = e.target.innerHTML;

                                                                            document.getElementById("removeDate").value = datee;
                                                                            document.getElementById("removeTutorId").value = @ViewData["userid"];
                                                                            document.getElementById("removeUserId").value = userid

                                                                            window.location.href = "#removeModal";
                                                                        }
                                                                    });

                                                                </script>
                                                                break;
                                                            }
                                                            else
                                                            {
                                                                <script>
                                                                    var elem = document.getElementsByClassName('@btn');
                                                                    elem[0].parentNode.removeChild(elem[0]);
                                                                </script>
                                                                var label = $"label_{model1.UserId}_{model1.Date.dateTimes[0].ToString("dd-MM-yyyy-HH-mm")}_{countA}_{countB}";
                                                                <div id="tooltrip">
                                                                    <label data-title="Курс: @model1.Course?.Title; Цель: @model1.Course?.Goal?.Title; Имя и фамилия: @model1.UserName" id="@label" class="label_@btn" style="background-color:lightblue;">@model1.UserName.ToString()</label>
                                                                </div>
                                                                <script>
                                                                    $("#@label").mousedown(function (e) {
                                                                        if (e.which === 3) {
                                                                            var _class = e.target.getAttribute("id");
                                                                            var sub = _class.split("_");
                                                                            var datee = sub[2];
                                                                            var userid = sub[1];
                                                                            
                                                                            var name = e.target.innerHTML;

                                                                            document.getElementById("removeDate").value = datee;
                                                                            document.getElementById("removeTutorId").value = @ViewData["userid"];
                                                                            document.getElementById("removeUserId").value = userid

                                                                            window.location.href = "#removeModal";
                                                                          
                                                                        }
                                                                    });

                                                                  </script>
                                                                    <style>
                                                                    label[data-title] {
                                                                      position: relative;
                                                                      display: inline-block;
                                                                      cursor: pointer;
                                                                      border-bottom: 1px dashed #000;
                                                                    }

                                                                        label[data-title]:hover:before {
                                                                      content: attr(data-title);
                                                                      position: absolute;
                                                                      width: 100px;
                                                                      color: #fff;
                                                                      background: #000;
                                                                      padding: 5px;
                                                                      border-radius: 4px;
                                                                      bottom: 25px;
                                                                      left: 50px;
                                                                    }
                                                                </style>
                                                                break;
                                                            }
                                                        }
                                                        else
                                                        { 
                                                            <script>
                                                                    var elem = document.getElementsByClassName('@btn');
                                                                    elem[0].parentNode.removeChild(elem[0]);
                                                            </script>

                                                            <label style="background-color:lightblue">@model1.TutorFullName.ToString()</label>
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                </div>
                            </td>
                            countB++;
                        }
                    }
                </tr>
                countA++;
            }
    }    
    </table>

    
</div>

</div>

@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.SignalR.Client;
@model HubConnection;
@{
    Layout = "_Layout";
}

<style>
    .chat {
        margin-top: auto;
        margin-bottom: auto;
    }

    .card {
        height: 500px;
        border-radius: 15px !important;
        background-color: rgba(0,0,0,0.4) !important;
    }

    .contacts_body {
        padding: 0.75rem 0 !important;
        overflow-y: auto;
        white-space: nowrap;
    }

    /*        overflow-y: auto;
    */
.msg_card_body {
        overflow-y: auto;
    }

    .card-header {
        border-radius: 15px 15px 0 0 !important;
        border-bottom: 0 !important;
    }

    .card-footer {
        border-radius: 0 0 15px 15px !important;
        border-top: 0 !important;
    }

    .container {
        align-content: center;
    }

    .search {
        border-radius: 15px 0 0 15px !important;
        background-color: rgba(0,0,0,0.3) !important;
        border: 0 !important;
        color: white !important;
    }

        .search:focus {
            box-shadow: none !important;
            outline: 0px !important;
        }

    .type_msg {
        background-color: rgba(0,0,0,0.3) !important;
        border: 0 !important;
        color: white !important;
        height: 60px !important;
        overflow-y: auto;
    }

        .type_msg:focus {
            box-shadow: none !important;
            outline: 0px !important;
        }

    .attach_btn {
        border-radius: 15px 0 0 15px !important;
        background-color: rgba(0,0,0,0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .send_btn {
        border-radius: 0 15px 15px 0 !important;
        background-color: rgba(0,0,0,0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .search_btn {
        border-radius: 0 15px 15px 0 !important;
        background-color: rgba(0,0,0,0.3) !important;
        border: 0 !important;
        color: white !important;
        cursor: pointer;
    }

    .contacts {
        list-style: none;
        padding: 0;
    }

        .contacts li {
            width: 100% !important;
            padding: 5px 10px;
            margin-bottom: 15px !important;
        }

    .active {
        background-color: rgba(0,0,0,0.3);
    }

    .user_img {
        height: 70px;
        width: 70px;
        border: 1.5px solid #f5f6fa;
    }

    .user_img_msg {
        height: 40px;
        width: 40px;
        border: 1.5px solid #f5f6fa;
    }

    .img_cont {
        position: relative;
        height: 70px;
        width: 70px;
    }

    .img_cont_msg {
        height: 40px;
        width: 40px;
    }

    .online_icon {
        position: absolute;
        height: 15px;
        width: 15px;
        background-color: #4cd137;
        border-radius: 50%;
        bottom: 0.2em;
        right: 0.4em;
        border: 1.5px solid white;
    }

    .offline {
        background-color: #c23616 !important;
    }

    .user_info {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: 15px;
    }

        .user_info span {
            font-size: 20px;
            color: white;
        }

        .user_info p {
            font-size: 10px;
            color: rgba(255,255,255,0.6);
        }

    .video_cam {
        margin-left: 50px;
        margin-top: 5px;
    }

        .video_cam span {
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-right: 20px;
        }

    .msg_cotainer {
        margin-top: auto;
        margin-bottom: auto;
        margin-left: 10px;
        border-radius: 25px;
        background-color: #82ccdd;
        padding: 10px;
        position: relative;
  max-width: 100px;
        word-break: break-all;
    }

    .msg_cotainer_send {
        margin-top: auto;
        margin-bottom: auto;
        margin-right: 10px;
        max-width: 100px;
        border-radius: 25px;
        background-color: #78e08f;
        padding: 10px;
        position: relative;
  word-break: break-all;
    }

    .msg_time {
        position: absolute;
        left: 0;
        bottom: -15px;
        color: rgba(255,255,255,0.5);
        font-size: 10px;
    }

    .msg_time_send {
        position: absolute;
        right: 0;
        bottom: -15px;
        color: rgba(255,255,255,0.5);
        font-size: 10px;
    }

    .msg_head {
        position: relative;
    }

    #action_menu_btn {
        position: absolute;
        right: 10px;
        top: 10px;
        color: white;
        cursor: pointer;
        font-size: 20px;
    }

    .action_menu {
        z-index: 1;
        position: absolute;
        padding: 15px 0;
        background-color: rgba(0,0,0,0.5);
        color: white;
        border-radius: 15px;
        top: 30px;
        right: 15px;
        display: none;
    }

        .action_menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

            .action_menu ul li {
                width: 100%;
                padding: 10px 15px;
                margin-bottom: 5px;
            }

                .action_menu ul li i {
                    padding-right: 10px;
                }

                .action_menu ul li:hover {
                    cursor: pointer;
                    background-color: rgba(0,0,0,0.2);
                }

    .justify-content-end {
        background-color: #e09b1ecc;
        color: white;
        border-radius: 28px;
    }

    .justify-content-start {
        background-color: #ff005e6b;
        color: white;
        border-radius: 28px;

    }

    ul {
        list-style-type: none;
    }
</style>
<script src="~/js/signalR/signalr.min.js"></script>
<link href="~/bootstrap-4.1.3-dist/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
<script src="~/bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>
<!------ Include the above in your HEAD tag ---------->
<script>
    function chatSearch(){
                    var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("searchInput");
            filter = document.getElementById('searchInput').value.toUpperCase();
            table = document.getElementById("onlineUsersList");
            tr = table.getElementsByTagName("li");
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("p");
                for (j = 0; j < td.length; j++) {
                    txtValue = td[j].textContent || td[j].innerText || td[j].innerHTML;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                        break;
                    } else {
                        tr[i].style.display = "none";
                    }
                }

            }
    }

</script>
<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-4 col-xl-3 chat">
            <div class="card mb-sm-3 mb-md-0 contacts_card">
                <div class="card-header">
                    <div class="input-group">
                        <input type="text" placeholder="Поиск..." id="searchInput" class="form-control search">
                    </div>
                </div>
                <div class="card-body contacts_body">
                    <ui class="contacts">
                        <div id="onlineUsersList"></div>
                    </ui>
                </div>
                <div class="card-footer"></div>
            </div>
        </div>
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="user_info">
                            <span>Чат с: <span id="chat-with-name"></span></span>

                            <span hidden="hidden">Чат с: <span id="chat-with-id"></span></span>
                        </div>
                    </div>
                </div>
                <div class="card-body msg_card_body">
                    <ul>
                        <li id="messageListId"></li>
                    </ul>
                </div>
                <script>

                    function HideInput (el){
                        document.getElementById('x').hidden = 'hidden';
                        document.getElementById('x').hidden = 'hidden';
                        document.getElementById('fileInput').value = "";
                        document.getElementById('fileName').textContent = '';
                    }
                    function ShowX(el) {
                        if (el.files[0].size < 31457280){
                              document.getElementById('x').removeAttribute('hidden');
                              document.getElementById('fileName').textContent = el.files[0].name;
                        }else{
                            document.getElementById('fileName').textContent = 'Файл должен быть меньше 30 мб';
                            document.getElementById('fileInput').value = "";
                        }
                      
                    }
                </script>
                <div class="card-footer">
                    <div class="input-group">
                        <div class="input-group-append">
                            <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                        </div>
                        <textarea name="" class="form-control type_msg" id="messageInput" placeholder="Написать......">
                         </textarea>
                        <div class="input-group-append">
                            <span class="input-group-text send_btn" id="sendButton"><i class="fas fa-location-arrow"><b>></b></i></span>
                        </div>
                        <input onchange="ShowX(this)" type="file" id="fileInput" class="fileInput" style="display: none;">
                        <div class="input-group-append">
                            <span class="attach_btn" id="attachButton"><i class="fas fa-paperclip">&#128206;</i></span>
                        </div>  
                        <div id="loading-spinner" style="display: none;">
                            <i class="fa fa-spinner fa-spin"></i> Загрузка файла...
                        </div>
                    </div>
                    <div>
                        <span id="fileName"></span>
                        <input onclick="HideInput(this)" type="button" id="x" value="x" hidden="hidden" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</div>
<script>
    document.getElementById("searchInput").onkeyup = chatSearch;


    var url = "@web_app.Program.web_server_ip"+"/chatHub" + "?" + "token=" + "@ViewData["userid"]";
    const connection = new signalR.HubConnectionBuilder()
        .configureLogging(signalR.LogLevel.Debug)
        .withUrl(url)
        .configureLogging(signalR.LogLevel.Information)
        .build();
    connection.start().then(() => {
    });

    var receiverId = function (id, userId) {
        $('#chat-with-id').text(id);
        $('#chat-with-name').text(userId);

        connection.invoke("GetMessages", $('#chat-with-id').text()).then((result) => {
        }).catch(err => console.error(err.toString()));
        event.preventDefault();
    }
    var sendMessage = function () {

        const message = document.getElementById("messageInput").value;
        var hasFiles= document.getElementById("fileInput");
        if (hasFiles.files.length > 0) {
            const file = document.getElementById("fileInput").files[0];
            const reader = new FileReader();
            reader.addEventListener('load', () => {
                const attachment = {
                    fileName: file.name,
                    content: reader.result.split(',')[1]
                };
                document.getElementById("loading-spinner").style.display = "block";

                connection.invoke('SendMessageWithFile', attachment, $('#chat-with-id').text(), message)
                    .then(() => { document.getElementById("loading-spinner").style.display = "none";HideInput()})
                    .catch((err) => {document.getElementById("loading-spinner").style.display = "none";HideInput()});
            });

            reader.readAsDataURL(file);  

        }else{
            connection.invoke("SendMessage", message, $('#chat-with-id').text(), null).then((result) => {
            }).catch(err => console.error(err.toString()));
        }

        event.preventDefault();
         document.getElementById("messageInput").value = "";
    }
    document.getElementById("sendButton").addEventListener("click", event => {
        sendMessage();
    });
    $("#messageInput").keydown(function (e) {
        if (e.keyCode == 13) {
            sendMessage();
            e.preventDefault();
        }
    });
    connection.on("UserList", (connectionId, userId, photo) => {
        $('#onlineUsersList').append('<li class="active" onclick="receiverId(' + "'" + connectionId + "', '" + userId + "'" + ')">' +
            '<div class="d-flex bd-highlight">' +
            '<div class="img_cont">' +
            '<a href=""><img src='+photo+' alt="find and solve" class="rounded-circle user_img"></a>' +
            '</div>' +
            '<div id="user_info" class="user_info">' +
            '<p>' + userId + '</p>></div> </div></li>'
        )
    });
    connection.on("DisconnectUser", (connectionId) => {$('li:contains('+ connectionId +')').remove();});

    connection.on("ClearNow", () => {
        $('#messageListId').empty();
    });
    connection.on("OwnMessage", (message, filePath, photo) => {
        $('#messageListId').append('<li><div class="d-flex justify-content-end mb-4">' +
            '<div class= ""msg_cotainer">' + message + '<span class= "msg_time_send" ></span></div>' +
            '<div class="img_cont_msg">' +
            '<img src="' + photo + '" alt="find and solve" class="rounded-circle user_img_msg"> </div> </div></li>')

            if(filePath){

                    $('#messageListId').append('<li><div class="d-flex justify-content-end mb-4">' +
                '<div class= ""msg_cotainer"><a download href="' + '@web_app.Program.web_server_ip' +'/files/' + filePath + '">' + filePath + '</a><span class= "msg_time_send"></span></div>' +
        '<div class="img_cont_msg">' +
        '<img src="'+photo+'" alt="find and solve" class="rounded-circle user_img_msg"> </div> </div></li>')
                    }
    });
    connection.on("ReceiveMessage", (message, senderId, senderName, filePath, photo) => {
        $('#chat-with-id').text(senderId);
        $('#chat-with-name').text(senderName);
        $('#messageListId').append('<li><div class="d-flex justify-content-start mb-4">' +
            '<div class="img_cont_msg">' +
            '<img src="'+photo+'" alt="find and solve" class="rounded-circle user_img_msg"> </div> ' +
            '<div class= ""msg_cotainer">' + message + '<span class= "msg_time_send" ></span></div>' +
            '</div ></li>')

            if(filePath){
            $('#messageListId').append('<li><div class="d-flex justify-content-start mb-4">' +
                '<div class="img_cont_msg">' +
                '<img src="'+photo+'" alt="find and solve" class="rounded-circle user_img_msg"> </div> ' +
                '<div class= ""msg_cotainer"><a download href="'+'@web_app.Program.web_server_ip'+'/files/' + filePath + '">' + filePath + '</a><span class= "msg_time_send"></span></div>' +
                '</div ></li>')
            }
    });

    document.getElementById('attachButton').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
</script>
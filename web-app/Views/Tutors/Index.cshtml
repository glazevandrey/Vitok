@using Newtonsoft.Json;
@using web_server.Models;
@using web_server.Models.DBModels

@model List<Tutor>;

@{
    Layout = "_Layout";
}


<link rel="stylesheet" type="text/css" href="~/css/modal.css">

<style>


    label {
     display: block;
    }

    label > span {
        display: inline-block;
        width: 170px;
    }

    label > input {
        display: inline-block;
        width: 170px;
    }

    input#search {
        padding-left: 10px;
        font-size: 26px
    }
    td, th{
        text-align: center;
    }
    td, tr, th{
        border: 1px solid #DBDBDB;
        font-family: Poppins;
        font-size:24px;
    }
    .th1{
        width: 150px
    }
    @@media (min-width: 768px) {
        .th1 {
            width: 200px
        }
    }
    .th2 {
        width: 50px
    }
  /*  .updateForm{
        text-align:center;
    }

        .updateForm input {
        width:200px;
    }*/
</style>

<script>
    function closeModal(){
        if (#('addForm')[0].checkValidity()){
            window.location.hash = "#closeModal";

        }
    }
</script>
<div id="openModalAdd" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Выберите действие</h3>
                <a href="#" title="Close" class="close">×</a>
            </div>
            <div class="modal-body">

                <form class="addForm" style="font-size:20px" id="addForm" method="post" action="/tutors/addnewtutor">

                    <fieldset>
                        <legend>Добавить нового репетитора</legend>

                        <div class="container2" align="center">
                            <br/><br/>
                            <label>
                                <span>Фамилия</span>
                                <input id="lastName" required name="lastName" value="" />
                            </label>
                            <br />
                            <br />

                            <label>
                                <span>Имя</span>
                                <input name="firstName" required id="firstName" value="" />
                                <br />             <br />

                            </label>
                            <label>
                                <span>Отчество</span>
                                <input id="middleName" required name="middleName" value="" />
                                <br />             <br />

                            </label>
                            <label>
                                <span>Дата рождения</span>
                                <input name="birthDate" required id="birthDate" value="" />
                                <br />             <br />

                            </label>

                            <label style="display:none; color:darkred" id="email_error">Такая почта уже используется</label>
                            <br />
                            <label>

                                <span>Почта</span>

                                <input required name="email" id="email" onchange="validateEmail(this)" value="" />
                                <br />             <br />

                            </label>
                            <label>
                                <span>Пароль</span>
                                <input required name="password" id="password" value="" />
                                <br />             <br />

                            </label>
                            <label>
                                <span>Телефон</span>
                                <input required name="phone" id="phone" value="" />
                                <br />             <br />

                            </label>
                            <label>
                                <span>Курсы</span>
                                <input required name="courses" id="courses" placeholder="(напр. ЕГЭ;ОГЭ)" value="" />
                                <br />             <br />

                            </label>

                        </div>
                    </fieldset>
                    <br />

                    <div style="text-align:center">
                        <button type="submit" class="u-btn u-btn-round u-button-style u-custom-color-2 u-radius-10" style="color:black !important;display:inline-block" onclick="closeModal1()">
                            Добавить
                        </button>

                    </div>

                </form>


            </div>

        </div>
    </div>
</div>
        <br/>

        <br/>

        <div>
<input type="text" id="search" style="border-radius: 10px; border: 1px solid gray; height:50px;width:400px" placeholder="Поиск...">



    <button onclick="window.location.hash = '#openModalAdd'" class="u-btn u-btn-round u-button-style u-custom-color-2 u-radius-10" style="font-size:20px;margin-left: 20px;color:black !important; display:inline-block;margin-bottom:30px;height:50px;width:400px">
    Добавить нового репетитора
</button>
</div>
<br/>


<table style="border-collapse:collapse" id="table">
        <thead >
            <tr>
            <th colspan="10" style="background-color:#C1EEE9">Список репетиторов</th>
            </tr>
            <tr>
                <th class="th1">Фамилия</th>
           
            <th class="th1">Имя</th>
      
            <th class="th1">Отчество</th>

            <th class="th1">Дата рождения</th>
       
            <th class="th1">Почта</th>

            <th class="th1">Пароль</th>
        
                 <th class="th1">Телефон</th>


            <th class="th1">Курсы</th>
            <th class="th2"></th>
            <th class="th2"></th>

        </tr>
        </thead>
        <tbody id="table-body">
            @foreach (var item in Model)
            {
                 <tr>
                    <td>
                    @item.LastName
                    </td>

                    <td>
                    @item.FirstName
                    </td>

                    <td>
                    @item.MiddleName
                    </td>

                    <td>
                    @item.BirthDate.ToString("dd.MM.yyyy")
                    </td>

                    <td>
                    @item.Email
                    </td>

                    <td>
                    @item.Password
                    </td>

                    <td>
                    @item.Phone
                    </td>

                    <td>
                    @{
                        string cr = "";
                        if(item.Courses!= null)
                        {
                            foreach (var course in item.Courses)
                            {
                                cr += course.Title + ";";
                            }
                            cr = cr.TrimEnd(';');
                        }
                        @cr
                        }
                 
                    </td>

                <td>
                    <img style="width:30px;height:30px;cursor:pointer" src="~/content/images/arrow-square-up.svg" onclick="editRow(@item.UserId)"/>
                </td>
                <td>
                    <img style="width:30px;height:30px;cursor:pointer" src="~/content/images/arrow-square-up-1.svg" onclick="openRemove(@item.UserId)" />
                </td>

                </tr>   
            }
        
         
        </tbody>
    </table>

    <script>

        function closeRemove(){
                    window.location.href = "#closeRemoveModal";
        }

        function openRemove(id){
        document.getElementById('userIdRemove').value = id;
        window.location.href = "#openRemoveModal";

        }
    </script>
<div id="openRemoveModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    Подтвердите удаление репетитора из системы
                </h3>
                <a href="#closeRemoveModal" title="Close" class="close">×</a>
            </div>
            <div class="modal-body">
                <form method="post" action="/tutors/removeTutor">
                    <input hidden="hidden" value="" id="userIdRemove" name="userIdRemove" />
                    <br/>
                    <input type="submit" value="Удалить"/>
                    <input type="button" value="Отмена" onclick="closeRemove()">
                </form>

            </div>
        </div>
    </div>
</div>



<div id="openModal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    Репетитор
                </h3>
                <a href="#" title="Close" class="close">×</a>
            </div>
            <div class="modal-body">
                <form id="update-form" class="updateForm" method="post" style="font-size:20px" action="/tutors/updateTutor">

                    <fieldset>
                        <legend>Изменить репетитора</legend>
                        <br/>
                        <br />
                        <div>
                            <input hidden="hidden" value="" id="userIdEdit" name="userIdEdit" />
                            <label>
                                <span>Имя</span>

                                <input id="firstNameEdit" name="firstNameEdit" type="text" value="" />
                                <br />
                                <br />
                                <br />
                            </label>
                            <label><span>Фамилия</span>
                                <input id="lastNameEdit" name="lastNameEdit" type="text" value="" />
                                <br />
                                <br />
                                <br />
                            </label>
                            <label>
                                <span>Отчество</span>                
                                <input id="middleNameEdit" name="middleNameEdit" type="text" value="" />
                                <br />
                                <br />
                                <br />
                            </label>
                            <label>
                                <span>Дата рождения</span>                            <input id="birthDateEdit" min="1920-01-01" max="2050-12-31" name="birthDateEdit" type="date" value="" />
                                <br />
                                <br />
                            </label>
                       

                            <label><span>Номер телефона</span>
                                <input id="phoneEdit" name="phoneEdit" type="text" value="" />
                                <br />
                                <br />
                            </label>
                      
                            <label><span>Почта</span>
                                <input id="emailEdit" name="emailEdit" type="text" value="" />
                                <br />
                                <br />

                            </label>

                            <label><span>Пароль</span>
                                <input id="passwordEdit" name="passwordEdit" type="text" value="" />
                                <br />
                                <br />

                            </label><br />
                         
                            <label><span>Курсы</span>

                                <input id="coursesEdit" name="coursesEdit" type="text" value="" />
                                <br />
                                <br />
                            </label><br />
                          
                           

                        </div>
                     
                     
                        </fieldset>
                    <div style="text-align:center; padding-top:20px">
                        <button type="submit" class="u-btn u-btn-round u-button-style u-custom-color-2 u-radius-10" style="width:150px;color:black !important;display:inline-block" >
                            Сохранить
                        </button>
                        <button class="u-btn u-btn-round u-button-style u-custom-color-2 u-radius-10" style="width:150px; color:black !important;display:inline-block" onclick="window.location.href='#closeModal'">
                            Отмена
                        </button>
                    </div>
                </form>
              
            </div>
        </div>
    </div>
</div>


<script>

    function getUsers()
    {
        var model = @Html.Raw(Json.Serialize(Model));
        return model;
    }
    function editRow(userId) {

    // Get the user data for the row with the specified userId
    var user = getUsers().find(u => u.userId === userId);

    // Populate the form fields with the user data
        document.getElementById("firstNameEdit").value = user.firstName;
        document.getElementById("lastNameEdit").value = user.lastName;
        document.getElementById("middleNameEdit").value = user.middleName;
        const birthDate = new Date(user.birthDate);
        const formattedDate = `${birthDate.getFullYear()}-${(birthDate.getMonth() + 1).toString().padStart(2, '0')}-${birthDate.getDate().toString().padStart(2, '0')}`;
        document.getElementById("birthDateEdit").value = formattedDate;
        //document.getElementById("birthDateEdit").value = new Date(user.birthDate);
        document.getElementById("phoneEdit").value = user.phone;
        document.getElementById("passwordEdit").value = user.password;
        document.getElementById("userIdEdit").value = user.userId;
        document.getElementById("emailEdit").value = user.email;

        var c = "";
                for (i = 0; i < user.courses.length; i++) {
                c += user.courses[i].title + ';';
                }

        document.getElementById("coursesEdit").value = c;

    window.location.href = "#openModal";
}


    function searchTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("search");
        filter = input.value.toUpperCase();
        table = document.getElementById("table");
        tr = table.getElementsByTagName("tr");

        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            for (j = 0; j < td.length; j++) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                    break;
                } else {
                    tr[i].style.display = "none";
                }
            }
            
        }
    }

    document.getElementById("search").onkeyup = searchTable;

</script>
                
    <script>
        function validateEmail(el)
        {
            console.log("dfdf");
            var email = el.value;
        var emails = @Html.Raw(JsonConvert.SerializeObject(Model.Select(m=>m.Email).ToArray()));
        console.log(emails);

            if(emails.includes(email)){
                console.log("dfdfd");
            document.getElementById('email_error').style.display = 'inline-block';

            }else{
            document.getElementById('email_error').style.display = 'none'
        }

        }

    $('body').keydown(function (e) {
        if (e.which == 27) {
            window.location.href='#';
        }

    });

    </script>


@{

    if(ViewData["error"] != null)
    {
    
        <script>
 
      alert('@ViewData["error"].ToString()');
        </script>
    }
}